package kr.or.ddit.project.project.controller;

import java.util.List;

import javax.inject.Inject;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpSession;

import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestMethod;

import kr.or.ddit.member.vo.MemberVO;
import kr.or.ddit.project.issue.service.IIssueService;
import kr.or.ddit.project.issue.vo.IssueVO;
import kr.or.ddit.project.project.service.IProjectService;
import kr.or.ddit.project.project.vo.ProjectVO;
import kr.or.ddit.project.work.service.IWorkService;
import kr.or.ddit.project.work.vo.WorkVO;
import lombok.extern.slf4j.Slf4j;

@Slf4j
@Controller
@RequestMapping("/coco/project")
public class CrudProjectController {
	
	@Inject
	private IProjectService projectService;
	
	@Inject
	private IWorkService workService;
	
	@Inject
	private IIssueService issueService;

	@RequestMapping(value="/register", method = RequestMethod.GET)
	public String registerForm(ProjectVO project, Model model) {
		
//		Map<String, String> statusMap = new HashMap<String, String>();
//		statusMap.put("PS01", "모집중");
//		statusMap.put("PS02", "진행중");
//		statusMap.put("PS03", "완료");
//
//		model.addAttribute("statusMap",statusMap);
		model.addAttribute("project", project);
		return "project/register";
	}
	
	@RequestMapping(value="/register", method=RequestMethod.POST)
	public String register(HttpServletRequest req, ProjectVO project, Model model) {
		log.info("생성날짜" + project.getPjStartDate());
		
		HttpSession session = req.getSession();
		MemberVO sessionMember = (MemberVO) session.getAttribute("SessionInfo");
		project.setPjCreatorId(sessionMember.getMemId());
		project.setPjAdminId(sessionMember.getMemId());
		
		project.setPjPnum("5");
		project.setPjStatusCode("PS01");
		project.setPjProgress("0");
		projectService.register(project);
		model.addAttribute("msg","등록이 완료되었습니다.");
		return "project/success";
	}
	
	@RequestMapping(value="/list", method = RequestMethod.GET)
	public String projectList(Model model) {
		List<ProjectVO> projList = projectService.list();
		model.addAttribute("list", projList);
		return "project/list";
	}
	
	@RequestMapping(value="/detail/{pjId}",method=RequestMethod.GET)
	public String projectDetail(@PathVariable("pjId") String pjId,Model model) {
		
		String codeGrp = "WORK_PRIORITY";
		List<ProjectVO> priCode = projectService.comList(codeGrp);
		model.addAttribute("priCode", priCode);
		
		ProjectVO project = projectService.detail(pjId);
		
		List<WorkVO> workList = workService.list(pjId);
	
		IssueVO issue = new IssueVO();
		for(int i=0; i<workList.size(); i++) {
			String workNum = workList.get(i).getWorkNum();
			issue.setWorkNum(workNum);
			workList.get(i).setIssueList(issueService.issueList(workNum));
		}
		System.out.println(workList);
		
		model.addAttribute("project", project);
		model.addAttribute("workList",workList);
		return "project/detail";
	}
	
	@RequestMapping(value="/modify", method=RequestMethod.GET)
	public String projectModify(String pjId,Model model) {
		
		String codeGrp = "PROJECT_STATE";
		List<ProjectVO> code = projectService.comList(codeGrp);
		model.addAttribute("code", code);
		
		ProjectVO project = projectService.detail(pjId);
		model.addAttribute("project", project);
		return "project/modify";
	}
	
	@RequestMapping(value="/modify", method=RequestMethod.POST)
	public String projectModify(ProjectVO project, Model model) {
//		log.info("퍼센트:" + project.getPjProgress());
		projectService.modify(project);
		model.addAttribute("msg", "수정이 완료되었습니다.");
		return "project/success";
	}
	
	@RequestMapping(value="/delete", method=RequestMethod.POST)
	public String projectDelete(String pjId, Model model) {
		projectService.delete(pjId);
		model.addAttribute("msg", "삭제가 완료되었습니다.");
		return "project/success"; 
	}
}
