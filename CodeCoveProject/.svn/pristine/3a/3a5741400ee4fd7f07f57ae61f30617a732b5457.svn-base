<%@ page language="java" contentType="text/html; charset=UTF-8"
	pageEncoding="UTF-8"%>
<%@ taglib uri="http://java.sun.com/jsp/jstl/core" prefix="c"%>
<script type="text/javascript"
	src="${pageContext.request.contextPath }/resources/plugins/jquery/jquery.min.js"></script>
<div class="register-box">
	<div class="card card-outline card-primary">
		<div class="card-body">
			<p class="login-box-msg">회원가입</p>

			<form action="/signup.do" method="post" id="signupForm"
				enctype="multipart/form-data">
				<div class="input-group mb-3 text-center">
					<img class="profile-user-img img-fluid img-circle"
						alt="User Profile" src=""
						id="profileImg" style="width: 150px;">
				</div>
				<div class="input-group mb-3">
					<label for="inputDescription">프로필 이미지</label>
				</div>
				<div class="input-group mb-3">
					<div class="custom-file">
						<input type="file" class="custom-file-input" name="imgFile"
							id="imgFile" /> <label class="custom-file-label" for="imgFile">프로필
							이미지를 선택해주세요.</label>
					</div>
				</div>
				<div class="input-group mb-3">
					<label for="inputDescription">프로필 정보</label>
				</div>
				<font color="red" class="mt-4 mb-2" id="id">${errors.memId }</font>
				<div class="input-group mb-3">
					<input type="text" class="form-control" id="memId" name="memId" required
						value="${member.memId }" placeholder="아이디를 입력해주세요"> <span
						class="input-group-append">
						<button type="button" class="btn btn-secondary btn-flat"
							id="idCheckBtn">중복확인</button>
					</span>
				</div>
				<font color="red" class="mt-4 mb-2">${errors.memPass }</font>
				<div class="input-group mb-3">
					<input type="text" class="form-control" id="memPass" name="memPass" required
						placeholder="비밀번호를 입력해주세요">
				</div>
				<font color="red" class="mt-4 mb-2">${errors.memName }</font>
				<div class="input-group mb-3">
					<input type="text" class="form-control" id="memName" name="memName" required
						value="${member.memName }" placeholder="이름을 입력해주세요">
				</div>
				<div class="input-group mb-3">
					<input type="text" class="form-control" id="memNick" name="memNick" required
						value="${member.memNick }" placeholder="별명을 입력해주세요">
				</div>
				<div class="input-group mb-3">
					<input type="email" class="form-control" id="memMail" name="memMail" required
						value="${member.memMail }" placeholder="이메일을 입력해주세요">
				</div>
				<div class="input-group mb-3">
					<input type="text" class="form-control" id="memHP" name="memHP" required
						value="${member.memHP }" placeholder="전화번호를 입력해주세요">
				</div>
				<div class="row">
					<div class="col-8">
						<div class="icheck-primary">
							<input type="checkbox" id="memAgree" name="memAgree" value="Y">
							<label for="memAgree"> 개인정보 사용을 동의해주세요 <a href="#">개인정보방침</a></label>
						</div>
					</div>
					<div class="col-4">
						<button type="button" class="btn btn-primary btn-block"
							id="signupBtn">가입하기</button>
					</div>
				</div>
			</form>
		</div>
	</div>
</div>
<script type="text/javascript">
	$(function() {
		var signupForm = $("#signupForm");
		var idCheckBtn = $("#idCheckBtn");
		var signupBtn = $("#signupBtn");
		var idCheckFlag = false; // 중복확인 flag

		// 아이디 중복확인
		idCheckBtn.on("click", function() {
			$.ajax({
				type : "post",
				url : "/idCheck.do",
				data : {
					memId : $("#memId").val()
				},
				success : function(res) {
					// 결과로 넘어오는 데이터가 ServiceResult인데,
					// EXIST, NOTEXIST 에 따라서
					// "사용가능한 아이디입니다 또는 이미 사용중인 아이디입니다"를 출력
					// 중복확인 시, idCheckFlag 라는 스위쳐가 발동(true로 변환)
					var text = "사용 가능한 아이디입니다!";
					if (res == "NOTEXIST") { // 아이디 사용 가능
						alert(text);
						$("#id").html(text).css("color", "green");
						idCheckFlag = true; // 중복확인 했다는 flag 설정
					} else { // 아이디 중복
						text = "이미 사용중인 아이디입니다!";
						alert(text);
						$("#id").html(text);
					}
				}
			});
		});

		$("#imgFile").on("change", function(event) {
			var file = event.target.files[0];
			if (isImageFile(file)) {
				var reader = new FileReader();
				reader.onload = function(e) {
					$("#profileImg").attr("src", e.target.result);
				}
				reader.readAsDataURL(file);
			} else {
				alert("이미지 파일을 선택해주세요!");
			}
		});

		signupBtn.on("click", function() {
			// 아이디, 비밀번호, 이름까지만 일반적인 데이터 검증
			// 개인정보 처리방침 동의를 체크했을때만 가입하기가 가능하도록
			// 중복확인 처리가 true일때 
			var memId = $("#memId").val();
			var memPass = $("#memPass").val();
			var memName = $("#memName").val();
			var memAgree = $("#memAgree:checked").val();
			var agreeFlag = false; // 개인정보처리방침 동의 여부(false: x, true: o)

			// 개인정보 처리방침을 동의하게되면 Y값이 넘어오므로, 동의 여부는 true로 설정한다.
			if (memAgree == "Y") {
				agreeFlag = true;
			}

			// 개인정보 처리방침을 동의했습니까?
			// 아이디 중복체크를 이행하고 오셨습니까?
			// 오셨다구요? 그럼 가입하기를 진행하겠습니다.
			// 예? 안했다구요? 그럼 가입하기를 할 수 없습니다.
			if (agreeFlag) { // 개인정보 처리 방침 동의
				if (idCheckFlag) { // 아이디 중복 체크 완료
					signupForm.submit();
				} else { // 아이디 중복 체크 미완료
					alert("아이디 중복체크를 해주세요!");
				}
			} else { // 동의 X
				alert("개인정보 동의를 체크해주세요!");
			}
		});
	});

	function isImageFile(file) {
		var ext = file.name.split(".").pop().toLowerCase();
		return ($.inArray(ext, [ "jpg", "jpeg", "gif", "png" ]) === -1) ? false
				: true;
	}
</script>