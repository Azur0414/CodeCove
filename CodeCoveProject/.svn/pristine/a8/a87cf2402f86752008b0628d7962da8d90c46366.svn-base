<%@ page language="java" contentType="text/html; charset=UTF-8"%>
<%@taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core"%>
<%@ taglib uri="http://www.springframework.org/security/tags"
	prefix="sec"%>
<!DOCTYPE html>
<body>
	<section class="position-relative border-bottom">
		<div class="container pb-9 pb-lg-11">
			<img src="/resources/assets/img/1200x600/4.jpg" alt=""
				class="img-fluid shadow-lg rounded-4 mb-7 mb-lg-9 position-relative mt-n14">

			<div class="row">
				<div class="col-xl-9 mx-auto">
					<div class="position-relative pb-3 pb-lg-0">
						<div class="d-flex align-items-center w-100"></div>
						<div>
							<h5 class="my-2 display-6">${freeBoardVO.freeTitle }</h5>
							<div class="d-flex pt-2 mb-0 small align-items-center">
								<small class="text-body-secondary">${freeBoardVO.freeDate }</small>
								<span class="text-body-secondary d-inline-block"></span><br>
							</div>
							By ${freeBoardVO.writerId }
						</div>
						<div style="text-align: right;">
							<a href="/freeBoard/${freeBoardVO.freeNum}/update">수정</a> | <a
								href="/freeBoard/${freeBoardVO.freeNum}/delete">삭제</a>
						</div>
						<hr style="height: 20px;">
						<article class="article mb-9">
							<p class="mb-5">${freeBoardVO.freeContent }</p>
							<div class="row">
								<div class="col-md-6"></div>
								<div class="col-md-6"></div>
							</div>
							<div style="height: 200px;"></div>
							<!--//////////////////////////////첨부파일 시작////////////////////////////// -->
							<div>
								<c:if test="${not empty freeBoardVO.attatchList }">
									<div>
										<c:forEach items="${freeBoardVO.attatchList }" var="attatches">
											<a href="#" class="download"
												data-attnum="${attatches.attatchNum }"
												data-attorder="${attatches.attatchOrder }">${attatches.originNm }</a>
											<br>
										</c:forEach>
									</div>
								</c:if>
							</div>
							<form action="/download" id="downForm">
								<input type="hidden" name="attatchNum" id="attatchNum">
								<input type="hidden" name="attatchOrder" id="attatchOrder">
							</form>

							<!-- /////////////////////////////첨부파일 끝////////////////////////////////// -->
						</article>
						<!--/.article-->
						<div class="d-flex justify-content-end align-items-center mb-9">
							<div></div>
						</div>
						<!--/////////////////////////////댓글 시작/////////////////////////////-->
						<!--/.comments-->
						<h4 class="mb-4">댓글</h4>
						<div id="writeReply">
							<form id="writeForm" method="post" class="form-inline"
								action="/freeBoard/reply/write">
								<sec:csrfInput />
								<input type="hidden" name="boReplyTarget" value="${freeBoardVO.freeNum}" /> 
								<input type="hidden" name="boReplyWriter" id="loginId" value="${freeBoardVO.writerId}" />
								<table class="col-md-10" style="margin: auto;">
									<tr>
										<td colspan="2">
											<div class="d-flex justify-content-center">
												<div class="input-group" >
												<textarea id="writeTextArea" class="form-control mb-2 mr-2" rows="2" placeholder="댓글을 작성하세요" maxlength="150" name="boReplyContent" required="required"></textarea>
												</div>
												<input type="submit" value="댓글작성" id="writeBtn" class="btn btn-primary waves-effect waves-light" />
											</div>
										</td>
									</tr>
								</table>
							</form>
									<div class="mt-1"
										style="height: auto; min-height: 300px; width: 85%; margin: auto;">
										<div class="p-2 rounded" id="replyView"></div>
									</div>
									<button type="button" class="btn btn-primary"
										onclick="javascript:location.href='/freeBoard/list'"
										style="float: right;">목록</button>
						</div>
					</div>
				</div>
									<!--/////////////////////////////댓글 끝/////////////////////////////-->
			</div>
	</section>

	<!-- 	</main> -->
	<!-- begin Back to Top button -->
	<a href="#" class="toTop"> <i class="bx bxs-up-arrow"></i>
	</a>
	<!-- scripts -->
	<script src="/resources/js/fileDownload.js"></script>
	<script src="/resources/assets/js/theme.bundle.min.js"></script>
	<!--Autosize textarea-->
	<script src="/resources/assets/vendor/node_modules/js/autosize.min.js"></script>
	<script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
	
	<script>
	
		var ta = document.querySelector('textarea');
		let replyView = $("#replyView"); //댓글 리스트 뷰
		const loginMember = $("#loginId").val(); //로그인 회원아이디
		const urlMember = $("#loginId").val(); //url의 회원아이디
		const writeURL = $("#writeForm").attr("action"); //댓글작성 URL
		console.log("writeURL:"+writeURL)
		const getURL = "/blog/${memId}/reply/${post.postNum}"; //댓글리스트 URL
		let writeForm = $("#writeForm");
		let reWriteForm = $("#reWriteForm");
		let upWriteForm=$("#upWriteForm");
		
		ta.style.display = 'none';
		autosize(ta);
		// Change layout
		ta.style.display = 'block';
		autosize.update(ta);
		
		(replyGet = function(event) {
			$.ajax({
				url : getURL,
				method : "get",
				dataType : "json",
				success : function(resp, status, jqXHR) {
					let replyList = resp.replyList;
					let replyTags = [];
					let replyTag = "";
					if (replyList && replyList.length > 0) {
						replyTags.push(toHtml(replyList));
					} else {

						replyTag += "<div style='text-align:center; font-size:20px;'>";
						replyTag += "댓글을 작성해보세요";
						replyTag += "</div>";
						replyTags.push(replyTag);
					}
					replyView.html(replyTags);
				}
				});
			})();
		
		let toHtml = function(replyList) {
			let tmp = "";
			let length = replyList.length;
			tmp += "<h5 class='font-size-14'>" + length + "개의 댓글</h5>"
			replyList
					.forEach(function(list) {
						let writer = list.blReplyWriter;
						if (list.blReplyNum != list.parentBlReplyNum) { //자식글
							tmp += "<div class='child' style='margin-left:40px;'>"
						} 
						tmp += "<div class='flex-grow-1 parent'>";
						tmp += "<span class='comment-img'>";
						tmp += "<i class='fa fa-user-circle' aria-hidden='true'></i>";
						tmp += "</span>";
						tmp += "<h5 class='font-size-15 mb-3'>&nbsp;작성자:"
								+ list.boReplyWriter + " | " + list.boReplyDate
								+ "</h5>";
						tmp += "<div class='oldData' data-rno="+list.boReplyNum+">";
						tmp += "<p>"+list.blReplyContent+"</p>"; // 서버쪽이 먼저 실행된다(해석할 수 있는 거)
						tmp += "</div>";
						tmp += "</div>" //flex-grow-1
						tmp += "</div>" //class='d-flex border-bottom pb-3
						tmp += "<br>"
					})
			return tmp;

		}
		<%-- form데이터 serialize  --%>
		jQuery.fn.serializeObject = function() {
			       var obj = null;
			       try {
			           if (this[0].tagName && this[0].tagName.toUpperCase() == "FORM") {
			               var arr = this.serializeArray();
			               if (arr) {
			                   obj = {};
			                   jQuery.each(arr, function() {
			                       obj[this.name] = this.value;
			                   });
			               }
			           }
			       } catch (e) {
			          swal(e.message);
			       } finally {
			       }
			       return obj;
			};
		//댓글작성
		writeForm.on("submit",function(event){
			
			console.log("폼 작동 확인",loginMember, "urlMember>>>",urlMember  );
			event.preventDefault();
			let writeText=$("#writeTextArea").val();
			let writeData=writeForm.serializeObject();
			if(!loginMember){
				swal("로그인 된 회원만 작성가능합니다.","");
				$("#writeTextArea").val('');
				return false;
			}else{
				 if(writeText.indexOf("<script>") != -1 || writeText.indexOf("<SCRIPT>") != -1){
					swal("지원하지 않는 문자입니다.","");
					return false;
				}else{ 
					console.log("아작스 작동하는지 안하는지 봅시다");
					$.ajax({
						url : writeURL,
						data : JSON.stringify(writeData),
						method : 'POST',
						dataType : "text",
						contentType : "application/json;charset=utf-8",
						success : function(resp, status, jqXHR) {
							switch (resp) {
							case "부적절":
								swal("입력정보가 누락되었거나 정확하지 않습니다.");
								$("#writeTextArea").val('');
								break;
							case "성공":
								//swal("댓글 작성 성공","");
								$("#writeTextArea").val('');
								$("#replyAttr").css("display","none");
								$("#replyAttr").appendTo($("#comback"));
								replyGet();
								break;
							case "실패":
								swal("댓글작성 실패, 다시 시도해주세요","")
								$("#writeTextArea").val('');
								break;
							}
							
						},
						error : function(jqXHR, status, error) {
							console.log(jqXHR);
							console.log(status);
							console.log(error);
						}
					});
				}
			}
		});
	</script>

</body>
</html>
