<%@ page language="java" contentType="text/html; charset=UTF-8"
	pageEncoding="UTF-8"%>
	
	<div style="margin-top:80px"></div>
	
	            <section class="position-relative">
                <div class="container position-relative">
                    <div class="overflow-hidden">
                        <!--Profile info header-->
                        <div class="position-relative pt-5 pb-9 pb-lg-11">
                            <div class="row">
                                <div class="col-lg-9 mx-auto">
                                    <div class="pt-5 d-flex flex-column h-100">
	
                                        <div class="card shadow p-3 mb-3">
                                            <h5 class="mb-4">내 정보</h5>

                                            <form  action="/coco/profileUpdate" method="post" id="proFileUpdateForm" enctype="multipart/form-data" autocomplete="false">
                                            	<div>
													<img src="${member.memProfile }"   id="profileImg" style="width : 200px;" alt="User Profile Image"/><br/>
												</div>
												<input type="hidden" name="report" value="${member.report }"/> 
                                                <div class="row align-items-center">
                                                    <div class="col-md-12">
                                                        <div class="row">
                                                            <div class="col-md-6 mb-4">
                                                                <input type="file" class="form-control" id="imgFile" name="imgFile" accept="image/png, image/jpeg, image/gif">
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-6 mb-3">
                                                        <label class="form-label" for="memId">아이디</label>
                                                        <input type="text" class="form-control" name="memId" id="memId" value="${member.memId }" readonly/>
                                                    </div>
                                                    <div class="col-md-6 mb-3">
                                                        <label class="form-label" for="memPass">현재 비밀번호</label><a style="color:red; font-size:12px"> (필수)</a>
                                                        <input type="password" class="form-control" name="memPass" id="memPass" value="" required/>
                                                    </div>
                                                    <div class="col-md-6 mb-3">
                                                        <label class="form-label" for="memNewPass">새 비밀번호</label> <span id="passCheck" style="color:red; font-size:12px"></span>
                                                        <input type="password" class="form-control" name="memNewPass" id="memNewPass" />
                                                    </div>
                                                    <div class="col-md-6 mb-3">
                                                        <label class="form-label" for="memNewPassChk">새 비밀번호 확인</label>
                                                        <input type="password" class="form-control" id="memNewPassChk" />
                                                    </div>
                                                    <div class="col-md-6 mb-3">
                                                        <label class="form-label" for="memName">이름</label>
                                                        <input  type="text" class="form-control" name="memName" id="memName" value="${member.memName }"/>

                                                    </div>
                                                    <div class="col-md-6 mb-3">
                                                        <label class="form-label" for="memNick">별명</label>
                                                        <input type="text" name="memNick" id="memNick" value="${member.memNick }"
                                                            class="form-control">
                                                    </div>
                                                    <div class="col-md-6 mb-3">
                                                        <label class="form-label" for="memHP">전화번호</label>
                                                        <input type="text" class="form-control" name="memHP" id="memHP" value="${member.memHP }"/>
                                                    </div>
                                                    <div class="col-md-6 mb-3">
                                                        <label class="form-label" for="memHP">이메일</label>
                                                        <input type="text" class="form-control" name="memMail" id="memMail" value="${member.memMail }"/>
                                                    </div>

                                                    <div class="col-md-4 mb-3">
                                                        <label class="form-label">수신 동의 (선택사항)</label>
                                                        <div class="d-flex">
                                                            <div>
                                                                <div class="form-check">
                                                                    <input type="checkbox" id="comm_phone" checked
                                                                        class="form-check-input">
                                                                    <label for="comm_phone">SMS</label>
                                                                </div>
                                                            </div>
                                                            <div class="ms-3">
                                                                <div class="form-check">
                                                                    <input type="checkbox" id="comm_email" checked
                                                                        class="form-check-input">
                                                                    <label for="comm_email">Email</label>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="text-end">
                                                    <button type="button" id="submitBtn" class="btn btn-primary">변경사항 저장</button>
                                                </div>
                                            </form>
                                        </div>
                                       </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
            </section>


<script src="https://unpkg.com/filepond-plugin-image-preview/dist/filepond-plugin-image-preview.js"></script>
<script src="https://unpkg.com/filepond-plugin-file-poster/dist/filepond-plugin-file-poster.js"></script>
<script src="https://unpkg.com/filepond/dist/filepond.js"></script>
<script>

// 이미지 선택시 미리보기
$("#imgFile").on("change", function(event){
	   var file = event.target.files[0];
	   if(isImageFile(file)){
	      var reader = new FileReader();
	      reader.onload = function(e){
	         $("#profileImg").attr("src", e.target.result);
	      }
	      reader.readAsDataURL(file);
	   }else{
	      alert("이미지 파일을 선택해주세요!");
	   }
	});
	
	        const getPwCheck = RegExp(/([a-zA-Z0-9].*[!,@,#,$,%,^,&,*,?,_,~])/);
        	var proFileForm = $("#proFileUpdateForm");
        	var formBtn = $("#submitBtn");
        	
	    	// 새 비밀번호 입력시
	    	$("#memNewPass").keyup(function() {
	    		
	            // 비밀번호 유효성 검사 
	            if (!getPwCheck.test($(event.target).val()) || $(event.target).val().length < 8){
	              $('#passCheck').html('비밀번호는 특수문자 포함 8자 이상입니다.');
	            } else {
	               $('#passCheck').html('');
	            }
	            
	            
	    	});
        	
	    	// 폼 제출시
	    	formBtn.on("click", function() {
	    		
	        	var passval = $("#memPass").val();
	        	var newPassVal = $("#memNewPass").val();
	        	var newPassValChk = $("#memNewPassChk").val();
	        	
	    		console.log("폼클릭 제출 ");
	    		
	    		console.log("비번확인>> ", passval);
	    		
	    		// 비밀번호 미입력시
	    		if (passval == null || passval == "") {

					Swal.fire({
					  icon: 'warning',
					  title: '비밀번호 입력은 필수입니다!',
					  showConfirmButton: false,
					  timer: 1500
					})
					
					return false;
				} 
	    		
				// 새 비밀번호 + 비밀번호 확인 틀릴 시 체크
				if (( newPassVal != null || newPassVal != "") && newPassVal != newPassValChk) {
					Swal.fire({
					  icon: 'warning',
					  title: '새 비밀번호가 <br> 일치하지 않습니다.',
					  showConfirmButton: false,
					  timer: 1500
					})
					return false;
				}
				
				console.log("아작스 작동전");
				
				$.ajax({
					type : "post",
					url : "/coco/passCheck",
					data : {
						memId : $("#memId").val(),
						memPass : $("#memPass").val()
					},
					success : function(res) {
						console.log("아작스 결과  >> ", res); 
						
						if (res == "ok") { // 아이디 사용 가능
							console.log("비밀번호 일치!");
						
							proFileForm.submit();
							
// 							Swal.fire({
// 								  icon: 'success',
// 								  title: '변경사항을 저장하였습니다.',
// 								  showConfirmButton: false,
// 								  timer: 1500
// 								});
								
						} else { // 비밀번호 불일치
							Swal.fire({
							  icon: 'error',
							  title: '비밀번호가 일치하지 않습니다.',
							  showConfirmButton: false,
							  timer: 1500
							})
						}
					}
				});
				
	    	}); // formBtn 클릭시
	    	
	    	
//이미지 파일 확인용
function isImageFile(file){
   var ext = file.name.split(".").pop().toLowerCase();
   return ($.inArray(ext,["jpg", "jpeg", "gif", "png"]) === -1 ) ? false : true;
}
        	
        	
</script>
